


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > UserController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.healthcare.dashboard.controllers</a>
</div>

<h1>Coverage Summary for Class: UserController (com.healthcare.dashboard.controllers)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">UserController</td>
<td class="coverageStat">
  <span class="percent">
    70%
  </span>
  <span class="absValue">
    (7/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    32,6%
  </span>
  <span class="absValue">
    (15/46)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    56,1%
  </span>
  <span class="absValue">
    (37/66)
  </span>
</td>
</tr>
  <tr>
    <td class="name">UserController$ErrorResponse</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UserController$UserCreateRequest</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (15/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (15/15)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UserController$UserUpdateRequest</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (15/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (15/15)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    86%
  </span>
  <span class="absValue">
    (37/43)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    32,6%
  </span>
  <span class="absValue">
    (15/46)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    67%
  </span>
  <span class="absValue">
    (67/100)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.healthcare.dashboard.controllers;
&nbsp;
&nbsp;import com.healthcare.dashboard.entities.Role;
&nbsp;import com.healthcare.dashboard.entities.User;
&nbsp;import com.healthcare.dashboard.repositories.RoleRepository;
&nbsp;import com.healthcare.dashboard.repositories.UserRepository;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import org.springframework.http.HttpStatus;
&nbsp;import org.springframework.http.ResponseEntity;
&nbsp;import org.springframework.security.access.prepost.PreAuthorize;
&nbsp;import org.springframework.security.crypto.password.PasswordEncoder;
&nbsp;import org.springframework.web.bind.annotation.*;
&nbsp;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.List;
&nbsp;import java.util.Set;
&nbsp;
&nbsp;@RestController
&nbsp;@RequestMapping(&quot;/api/users&quot;)
<b class="fc">&nbsp;@RequiredArgsConstructor</b>
&nbsp;@CrossOrigin(origins = {&quot;http://localhost:3000&quot;, &quot;http://localhost:3001&quot;, &quot;http://localhost:3002&quot;, &quot;http://localhost:3003&quot;, &quot;http://localhost:5173&quot;, &quot;http://localhost:5174&quot;})
&nbsp;public class UserController {
&nbsp;    
&nbsp;    private final UserRepository userRepository;
&nbsp;    private final RoleRepository roleRepository;
&nbsp;    private final PasswordEncoder passwordEncoder;
&nbsp;    
&nbsp;    /**
&nbsp;     * Récupérer tous les utilisateurs
&nbsp;     * Accessible uniquement aux ADMIN et DIRECTION
&nbsp;     */
&nbsp;    @GetMapping
&nbsp;    // @PreAuthorize(&quot;hasAnyRole(&#39;ADMIN&#39;, &#39;DIRECTION&#39;, &#39;GESTIONNAIRE&#39;)&quot;) // Temporairement désactivé
&nbsp;    public ResponseEntity&lt;List&lt;User&gt;&gt; getAllUsers() {
<b class="fc">&nbsp;        return ResponseEntity.ok(userRepository.findAll());</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Récupérer un utilisateur par ID
&nbsp;     */
&nbsp;    @GetMapping(&quot;/{id}&quot;)
&nbsp;    // @PreAuthorize(&quot;hasAnyRole(&#39;ADMIN&#39;, &#39;DIRECTION&#39;, &#39;GESTIONNAIRE&#39;)&quot;) // Temporairement désactivé
&nbsp;    public ResponseEntity&lt;User&gt; getUserById(@PathVariable Long id) {
<b class="fc">&nbsp;        return userRepository.findById(id)</b>
<b class="fc">&nbsp;                .map(ResponseEntity::ok)</b>
<b class="fc">&nbsp;                .orElse(ResponseEntity.notFound().build());</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Créer un nouvel utilisateur
&nbsp;     * Accessible uniquement aux ADMIN
&nbsp;     */
&nbsp;    @PostMapping
&nbsp;    // @PreAuthorize(&quot;hasRole(&#39;ADMIN&#39;)&quot;) // Temporairement désactivé pour debug
&nbsp;    public ResponseEntity&lt;?&gt; createUser(@RequestBody UserCreateRequest request) {
&nbsp;        // Vérifier si le nom d&#39;utilisateur existe déjà
<b class="pc">&nbsp;        if (userRepository.findByUsername(request.getUsername()).isPresent()) {</b>
<b class="nc">&nbsp;            return ResponseEntity.badRequest()</b>
<b class="nc">&nbsp;                    .body(new ErrorResponse(&quot;Ce nom d&#39;utilisateur est déjà utilisé&quot;));</b>
&nbsp;        }
&nbsp;        
&nbsp;        // Vérifier si l&#39;email existe déjà
<b class="pc">&nbsp;        if (userRepository.findByEmail(request.getEmail()).isPresent()) {</b>
<b class="nc">&nbsp;            return ResponseEntity.badRequest()</b>
<b class="nc">&nbsp;                    .body(new ErrorResponse(&quot;Cet email est déjà utilisé&quot;));</b>
&nbsp;        }
&nbsp;        
&nbsp;        // Créer le nouvel utilisateur
<b class="fc">&nbsp;        User user = new User();</b>
<b class="fc">&nbsp;        user.setUsername(request.getUsername());</b>
<b class="fc">&nbsp;        user.setEmail(request.getEmail());</b>
<b class="pc">&nbsp;        user.setNom(request.getNom() != null ? request.getNom() : &quot;&quot;);</b>
<b class="pc">&nbsp;        user.setPrenom(request.getPrenom() != null ? request.getPrenom() : &quot;&quot;);</b>
<b class="fc">&nbsp;        user.setPassword(passwordEncoder.encode(request.getPassword()));</b>
<b class="pc">&nbsp;        user.setEnabled(request.getActif() != null ? request.getActif() : true);</b>
<b class="fc">&nbsp;        user.setCreatedAt(LocalDateTime.now());</b>
<b class="fc">&nbsp;        user.setUpdatedAt(LocalDateTime.now());</b>
&nbsp;        
&nbsp;        // Assigner les rôles
<b class="fc">&nbsp;        Set&lt;Role&gt; roles = new HashSet&lt;&gt;();</b>
<b class="pc">&nbsp;        if (request.getRoleIds() != null &amp;&amp; !request.getRoleIds().isEmpty()) {</b>
<b class="nc">&nbsp;            for (Long roleId : request.getRoleIds()) {</b>
<b class="nc">&nbsp;                roleRepository.findById(roleId).ifPresent(roles::add);</b>
&nbsp;            }
&nbsp;        }
&nbsp;        // Si aucun rôle n&#39;est assigné, ne rien faire (ou lever une erreur selon les besoins)
<b class="pc">&nbsp;        if (!roles.isEmpty()) {</b>
<b class="nc">&nbsp;            user.setRoles(roles);</b>
&nbsp;        }
&nbsp;        
<b class="fc">&nbsp;        User savedUser = userRepository.save(user);</b>
<b class="fc">&nbsp;        return ResponseEntity.status(HttpStatus.CREATED).body(savedUser);</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Mettre à jour un utilisateur
&nbsp;     * Accessible uniquement aux ADMIN
&nbsp;     */
&nbsp;    @PutMapping(&quot;/{id}&quot;)
&nbsp;    // @PreAuthorize(&quot;hasRole(&#39;ADMIN&#39;)&quot;) // Temporairement désactivé
&nbsp;    public ResponseEntity&lt;?&gt; updateUser(@PathVariable Long id, @RequestBody UserUpdateRequest request) {
<b class="fc">&nbsp;        return userRepository.findById(id)</b>
<b class="fc">&nbsp;                .map(user -&gt; {</b>
&nbsp;                    // Vérifier si le nouveau username est déjà utilisé par un autre utilisateur
<b class="pc">&nbsp;                    if (request.getUsername() != null &amp;&amp; !request.getUsername().equals(user.getUsername())) {</b>
<b class="nc">&nbsp;                        if (userRepository.findByUsername(request.getUsername()).isPresent()) {</b>
<b class="nc">&nbsp;                            return ResponseEntity.badRequest()</b>
<b class="nc">&nbsp;                                    .body(new ErrorResponse(&quot;Ce nom d&#39;utilisateur est déjà utilisé&quot;));</b>
&nbsp;                        }
<b class="nc">&nbsp;                        user.setUsername(request.getUsername());</b>
&nbsp;                    }
&nbsp;                    
&nbsp;                    // Vérifier si le nouvel email est déjà utilisé par un autre utilisateur
<b class="pc">&nbsp;                    if (request.getEmail() != null &amp;&amp; !request.getEmail().equals(user.getEmail())) {</b>
<b class="nc">&nbsp;                        if (userRepository.findByEmail(request.getEmail()).isPresent()) {</b>
<b class="nc">&nbsp;                            return ResponseEntity.badRequest()</b>
<b class="nc">&nbsp;                                    .body(new ErrorResponse(&quot;Cet email est déjà utilisé&quot;));</b>
&nbsp;                        }
<b class="nc">&nbsp;                        user.setEmail(request.getEmail());</b>
&nbsp;                    }
&nbsp;                    
&nbsp;                    // Mettre à jour les autres champs
<b class="pc">&nbsp;                    if (request.getNom() != null) user.setNom(request.getNom());</b>
<b class="pc">&nbsp;                    if (request.getPrenom() != null) user.setPrenom(request.getPrenom());</b>
<b class="pc">&nbsp;                    if (request.getPassword() != null &amp;&amp; !request.getPassword().isEmpty()) {</b>
<b class="nc">&nbsp;                        user.setPassword(passwordEncoder.encode(request.getPassword()));</b>
&nbsp;                    }
<b class="pc">&nbsp;                    if (request.getActif() != null) {</b>
<b class="nc">&nbsp;                        user.setEnabled(request.getActif());</b>
&nbsp;                    }
&nbsp;                    
&nbsp;                    // Mettre à jour les rôles si fournis
<b class="pc">&nbsp;                    if (request.getRoleIds() != null) {</b>
<b class="nc">&nbsp;                        Set&lt;Role&gt; roles = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;                        for (Long roleId : request.getRoleIds()) {</b>
<b class="nc">&nbsp;                            roleRepository.findById(roleId).ifPresent(roles::add);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        user.setRoles(roles);</b>
&nbsp;                    }
&nbsp;                    
<b class="fc">&nbsp;                    user.setUpdatedAt(LocalDateTime.now());</b>
<b class="fc">&nbsp;                    User updatedUser = userRepository.save(user);</b>
<b class="fc">&nbsp;                    return ResponseEntity.ok(updatedUser);</b>
&nbsp;                })
<b class="fc">&nbsp;                .orElse(ResponseEntity.notFound().build());</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Supprimer un utilisateur
&nbsp;     * Accessible uniquement aux ADMIN
&nbsp;     */
&nbsp;    @DeleteMapping(&quot;/{id}&quot;)
&nbsp;    // @PreAuthorize(&quot;hasRole(&#39;ADMIN&#39;)&quot;) // Temporairement désactivé
&nbsp;    public ResponseEntity&lt;Void&gt; deleteUser(@PathVariable Long id) {
<b class="pc">&nbsp;        if (userRepository.existsById(id)) {</b>
<b class="fc">&nbsp;            userRepository.deleteById(id);</b>
<b class="fc">&nbsp;            return ResponseEntity.ok().build();</b>
&nbsp;        }
<b class="nc">&nbsp;        return ResponseEntity.notFound().build();</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Activer/Désactiver un utilisateur
&nbsp;     */
&nbsp;    @PutMapping(&quot;/{id}/toggle-status&quot;)
&nbsp;    // @PreAuthorize(&quot;hasRole(&#39;ADMIN&#39;)&quot;) // Temporairement désactivé
&nbsp;    public ResponseEntity&lt;User&gt; toggleUserStatus(@PathVariable Long id) {
<b class="nc">&nbsp;        return userRepository.findById(id)</b>
<b class="nc">&nbsp;                .map(user -&gt; {</b>
<b class="nc">&nbsp;                    user.setEnabled(!user.getEnabled());</b>
<b class="nc">&nbsp;                    user.setUpdatedAt(LocalDateTime.now());</b>
<b class="nc">&nbsp;                    return ResponseEntity.ok(userRepository.save(user));</b>
&nbsp;                })
<b class="nc">&nbsp;                .orElse(ResponseEntity.notFound().build());</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Récupérer tous les rôles disponibles
&nbsp;     */
&nbsp;    @GetMapping(&quot;/roles&quot;)
&nbsp;    // @PreAuthorize(&quot;hasAnyRole(&#39;ADMIN&#39;, &#39;DIRECTION&#39;)&quot;) // Temporairement désactivé
&nbsp;    public ResponseEntity&lt;List&lt;Role&gt;&gt; getAllRoles() {
<b class="nc">&nbsp;        return ResponseEntity.ok(roleRepository.findAll());</b>
&nbsp;    }
&nbsp;    
&nbsp;    // Classes internes pour les requêtes
&nbsp;    
<b class="fc">&nbsp;    public static class UserCreateRequest {</b>
&nbsp;        private String username;
&nbsp;        private String password;
&nbsp;        private String email;
&nbsp;        private String nom;
&nbsp;        private String prenom;
&nbsp;        private Boolean actif;
&nbsp;        private List&lt;Long&gt; roleIds;
&nbsp;        
&nbsp;        // Getters et Setters
<b class="fc">&nbsp;        public String getUsername() { return username; }</b>
<b class="fc">&nbsp;        public void setUsername(String username) { this.username = username; }</b>
&nbsp;        
<b class="fc">&nbsp;        public String getPassword() { return password; }</b>
<b class="fc">&nbsp;        public void setPassword(String password) { this.password = password; }</b>
&nbsp;        
<b class="fc">&nbsp;        public String getEmail() { return email; }</b>
<b class="fc">&nbsp;        public void setEmail(String email) { this.email = email; }</b>
&nbsp;        
<b class="fc">&nbsp;        public String getNom() { return nom; }</b>
<b class="fc">&nbsp;        public void setNom(String nom) { this.nom = nom; }</b>
&nbsp;        
<b class="fc">&nbsp;        public String getPrenom() { return prenom; }</b>
<b class="fc">&nbsp;        public void setPrenom(String prenom) { this.prenom = prenom; }</b>
&nbsp;        
<b class="fc">&nbsp;        public Boolean getActif() { return actif; }</b>
<b class="fc">&nbsp;        public void setActif(Boolean actif) { this.actif = actif; }</b>
&nbsp;        
<b class="fc">&nbsp;        public List&lt;Long&gt; getRoleIds() { return roleIds; }</b>
<b class="fc">&nbsp;        public void setRoleIds(List&lt;Long&gt; roleIds) { this.roleIds = roleIds; }</b>
&nbsp;    }
&nbsp;    
<b class="fc">&nbsp;    public static class UserUpdateRequest {</b>
&nbsp;        private String username;
&nbsp;        private String password;
&nbsp;        private String email;
&nbsp;        private String nom;
&nbsp;        private String prenom;
&nbsp;        private Boolean actif;
&nbsp;        private List&lt;Long&gt; roleIds;
&nbsp;        
&nbsp;        // Getters et Setters
<b class="fc">&nbsp;        public String getUsername() { return username; }</b>
<b class="fc">&nbsp;        public void setUsername(String username) { this.username = username; }</b>
&nbsp;        
<b class="fc">&nbsp;        public String getPassword() { return password; }</b>
<b class="fc">&nbsp;        public void setPassword(String password) { this.password = password; }</b>
&nbsp;        
<b class="fc">&nbsp;        public String getEmail() { return email; }</b>
<b class="fc">&nbsp;        public void setEmail(String email) { this.email = email; }</b>
&nbsp;        
<b class="fc">&nbsp;        public String getNom() { return nom; }</b>
<b class="fc">&nbsp;        public void setNom(String nom) { this.nom = nom; }</b>
&nbsp;        
<b class="fc">&nbsp;        public String getPrenom() { return prenom; }</b>
<b class="fc">&nbsp;        public void setPrenom(String prenom) { this.prenom = prenom; }</b>
&nbsp;        
<b class="fc">&nbsp;        public Boolean getActif() { return actif; }</b>
<b class="fc">&nbsp;        public void setActif(Boolean actif) { this.actif = actif; }</b>
&nbsp;        
<b class="fc">&nbsp;        public List&lt;Long&gt; getRoleIds() { return roleIds; }</b>
<b class="fc">&nbsp;        public void setRoleIds(List&lt;Long&gt; roleIds) { this.roleIds = roleIds; }</b>
&nbsp;    }
&nbsp;    
&nbsp;    public static class ErrorResponse {
&nbsp;        private String message;
&nbsp;        
<b class="nc">&nbsp;        public ErrorResponse(String message) {</b>
<b class="nc">&nbsp;            this.message = message;</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        public String getMessage() { return message; }</b>
<b class="nc">&nbsp;        public void setMessage(String message) { this.message = message; }</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-12-24 10:59</div>
</div>
</body>
</html>
