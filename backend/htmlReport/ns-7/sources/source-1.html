


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > AIService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.healthcare.dashboard.services</a>
</div>

<h1>Coverage Summary for Class: AIService (com.healthcare.dashboard.services)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">AIService</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    60%
  </span>
  <span class="absValue">
    (3/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    31,2%
  </span>
  <span class="absValue">
    (5/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    80,8%
  </span>
  <span class="absValue">
    (59/73)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.healthcare.dashboard.services;
&nbsp;
&nbsp;import com.healthcare.dashboard.dto.AIResponse;
&nbsp;import com.healthcare.dashboard.repositories.*;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.web.client.RestTemplate;
&nbsp;import org.springframework.http.*;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.fasterxml.jackson.databind.ObjectMapper;
&nbsp;
&nbsp;import java.time.LocalDate;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.Map;
&nbsp;
&nbsp;@Service
<b class="fc">&nbsp;@RequiredArgsConstructor</b>
&nbsp;public class AIService {
&nbsp;    
&nbsp;    @Value(&quot;${google.ai.api.key}&quot;)
&nbsp;    private String apiKey;
&nbsp;    
&nbsp;    @Value(&quot;${google.ai.model:gemini-2.5-flash-lite}&quot;)
&nbsp;    private String model;
&nbsp;    
&nbsp;    private final PatientRepository patientRepository;
&nbsp;    private final ServiceRepository serviceRepository;
&nbsp;    private final SejourRepository sejourRepository;
&nbsp;    private final ActeMedicalRepository acteMedicalRepository;
&nbsp;    private final RestTemplate restTemplate;
&nbsp;    private final ObjectMapper objectMapper;
&nbsp;    
&nbsp;    public AIResponse askAI(String question) {
&nbsp;        try {
&nbsp;            // R√©cup√©rer les statistiques de la base de donn√©es
<b class="fc">&nbsp;            String context = buildContextFromDatabase();</b>
&nbsp;            
&nbsp;            // Construire le prompt avec le contexte
<b class="fc">&nbsp;            String fullPrompt = String.format(</b>
&nbsp;                &quot;Tu es un assistant AI sp√©cialis√© dans l&#39;analyse de donn√©es hospitali√®res.\n\n&quot; +
&nbsp;                &quot;Contexte des donn√©es actuelles:\n%s\n\n&quot; +
&nbsp;                &quot;Question de l&#39;utilisateur: %s\n\n&quot; +
&nbsp;                &quot;R√©ponds en fran√ßais de mani√®re professionnelle et pr√©cise. Utilise les donn√©es r√©elles fournies.&quot;,
&nbsp;                context, question
&nbsp;            );
&nbsp;            
&nbsp;            // Appeler l&#39;API Google Gemini
<b class="fc">&nbsp;            String url = String.format(</b>
&nbsp;                &quot;https://generativelanguage.googleapis.com/v1/models/%s:generateContent?key=%s&quot;,
&nbsp;                model, apiKey
&nbsp;            );
&nbsp;            
<b class="fc">&nbsp;            Map&lt;String, Object&gt; requestBody = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;            Map&lt;String, Object&gt; part = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;            part.put(&quot;text&quot;, fullPrompt);</b>
&nbsp;            
<b class="fc">&nbsp;            Map&lt;String, Object&gt; content = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;            content.put(&quot;parts&quot;, new Object[]{part});</b>
&nbsp;            
<b class="fc">&nbsp;            requestBody.put(&quot;contents&quot;, new Object[]{content});</b>
&nbsp;            
<b class="fc">&nbsp;            HttpHeaders headers = new HttpHeaders();</b>
<b class="fc">&nbsp;            headers.setContentType(MediaType.APPLICATION_JSON);</b>
&nbsp;            
<b class="fc">&nbsp;            HttpEntity&lt;Map&lt;String, Object&gt;&gt; entity = new HttpEntity&lt;&gt;(requestBody, headers);</b>
<b class="fc">&nbsp;            ResponseEntity&lt;String&gt; response = restTemplate.exchange(url, HttpMethod.POST, entity, String.class);</b>
&nbsp;            
&nbsp;            // Parser la r√©ponse
<b class="fc">&nbsp;            JsonNode jsonResponse = objectMapper.readTree(response.getBody());</b>
<b class="fc">&nbsp;            String answer = jsonResponse</b>
<b class="fc">&nbsp;                .path(&quot;candidates&quot;).get(0)</b>
<b class="fc">&nbsp;                .path(&quot;content&quot;)</b>
<b class="fc">&nbsp;                .path(&quot;parts&quot;).get(0)</b>
<b class="fc">&nbsp;                .path(&quot;text&quot;).asText();</b>
&nbsp;            
<b class="fc">&nbsp;            return new AIResponse(</b>
&nbsp;                answer,
<b class="fc">&nbsp;                0.9,</b>
&nbsp;                new String[]{&quot;Google Gemini AI&quot;, &quot;Base de donn√©es MySQL en temps r√©el&quot;}
&nbsp;            );
&nbsp;            
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            e.printStackTrace();</b>
<b class="fc">&nbsp;            return new AIResponse(</b>
<b class="fc">&nbsp;                &quot;D√©sol√©, une erreur est survenue lors de l&#39;analyse. D√©tails: &quot; + e.getMessage(),</b>
<b class="fc">&nbsp;                0.0,</b>
&nbsp;                new String[]{&quot;Erreur syst√®me&quot;}
&nbsp;            );
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    private String buildContextFromDatabase() {
<b class="fc">&nbsp;        StringBuilder context = new StringBuilder();</b>
<b class="fc">&nbsp;        context.append(&quot;üìä Statistiques Hospitali√®res Actuelles:\n\n&quot;);</b>
&nbsp;        
&nbsp;        try {
&nbsp;            // Compter les patients
<b class="fc">&nbsp;            long totalPatients = patientRepository.count();</b>
<b class="fc">&nbsp;            context.append(String.format(&quot;üë• PATIENTS:\n‚Ä¢ Total de patients enregistr√©s: %d\n&quot;, totalPatients));</b>
&nbsp;            
&nbsp;            // R√©cup√©rer quelques patients pour le contexte
<b class="fc">&nbsp;            var patients = patientRepository.findAll();</b>
<b class="pc">&nbsp;            if (!patients.isEmpty()) {</b>
<b class="nc">&nbsp;                context.append(&quot;‚Ä¢ Exemples de patients:\n&quot;);</b>
<b class="nc">&nbsp;                patients.stream().limit(5).forEach(p -&gt; </b>
<b class="nc">&nbsp;                    context.append(String.format(&quot;  - %s %s (n√©(e) le %s)\n&quot;, </b>
<b class="nc">&nbsp;                        p.getPrenom(), p.getNom(), </b>
<b class="nc">&nbsp;                        p.getDateNaissance() != null ? p.getDateNaissance().toString() : &quot;N/A&quot;))</b>
&nbsp;                );
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            context.append(&quot;‚Ä¢ Patients: Erreur de r√©cup√©ration\n&quot;);</b>
&nbsp;        }
&nbsp;        
&nbsp;        try {
&nbsp;            // Compter les services
<b class="fc">&nbsp;            long totalServices = serviceRepository.count();</b>
<b class="fc">&nbsp;            context.append(String.format(&quot;\nüè• SERVICES:\n‚Ä¢ Total de services: %d\n&quot;, totalServices));</b>
&nbsp;            
<b class="fc">&nbsp;            var services = serviceRepository.findAll();</b>
<b class="pc">&nbsp;            if (!services.isEmpty()) {</b>
<b class="nc">&nbsp;                context.append(&quot;‚Ä¢ Liste des services:\n&quot;);</b>
<b class="nc">&nbsp;                services.forEach(s -&gt; </b>
<b class="nc">&nbsp;                    context.append(String.format(&quot;  - %s (Responsable: %s, Lits: %d)\n&quot;, </b>
<b class="nc">&nbsp;                        s.getNom(), </b>
<b class="nc">&nbsp;                        s.getResponsable() != null ? s.getResponsable() : &quot;N/A&quot;,</b>
<b class="nc">&nbsp;                        s.getLitsDisponibles() != null ? s.getLitsDisponibles() : 0))</b>
&nbsp;                );
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            context.append(&quot;‚Ä¢ Services: Erreur de r√©cup√©ration\n&quot;);</b>
&nbsp;        }
&nbsp;        
&nbsp;        try {
&nbsp;            // Compter les s√©jours
<b class="fc">&nbsp;            long totalSejours = sejourRepository.count();</b>
<b class="fc">&nbsp;            long sejoursEnCours = 0;</b>
&nbsp;            try {
<b class="fc">&nbsp;                sejoursEnCours = sejourRepository.countByStatut(&quot;EN_COURS&quot;);</b>
&nbsp;            } catch (Exception ignored) {}
&nbsp;            
<b class="fc">&nbsp;            context.append(String.format(&quot;\nüõèÔ∏è S√âJOURS:\n‚Ä¢ Total de s√©jours: %d\n‚Ä¢ S√©jours en cours: %d\n&quot;, </b>
<b class="fc">&nbsp;                totalSejours, sejoursEnCours));</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            context.append(&quot;‚Ä¢ S√©jours: Erreur de r√©cup√©ration\n&quot;);</b>
&nbsp;        }
&nbsp;        
&nbsp;        try {
&nbsp;            // Compter les actes m√©dicaux et revenus
<b class="fc">&nbsp;            long totalActes = acteMedicalRepository.count();</b>
<b class="fc">&nbsp;            context.append(String.format(&quot;\nüíä ACTES M√âDICAUX:\n‚Ä¢ Total d&#39;actes r√©alis√©s: %d\n&quot;, totalActes));</b>
&nbsp;            
<b class="fc">&nbsp;            Double revenusTotal = null;</b>
<b class="fc">&nbsp;            Double revenusMois = null;</b>
<b class="fc">&nbsp;            Double revenusAnnee = null;</b>
&nbsp;            
&nbsp;            try {
<b class="fc">&nbsp;                revenusTotal = acteMedicalRepository.sumAllTarif();</b>
&nbsp;            } catch (Exception ignored) {}
&nbsp;            
&nbsp;            try {
<b class="fc">&nbsp;                LocalDateTime startOfMonth = LocalDate.now().withDayOfMonth(1).atStartOfDay();</b>
<b class="fc">&nbsp;                LocalDateTime endOfMonth = LocalDate.now().withDayOfMonth(LocalDate.now().lengthOfMonth()).atTime(23, 59, 59);</b>
<b class="fc">&nbsp;                revenusMois = acteMedicalRepository.sumTarifByDateBetween(startOfMonth, endOfMonth);</b>
&nbsp;            } catch (Exception ignored) {}
&nbsp;            
&nbsp;            try {
<b class="fc">&nbsp;                LocalDateTime startOfYear = LocalDate.now().withDayOfYear(1).atStartOfDay();</b>
<b class="fc">&nbsp;                LocalDateTime endOfYear = LocalDate.now().withMonth(12).withDayOfMonth(31).atTime(23, 59, 59);</b>
<b class="fc">&nbsp;                revenusAnnee = acteMedicalRepository.sumTarifByDateBetween(startOfYear, endOfYear);</b>
&nbsp;            } catch (Exception ignored) {}
&nbsp;            
<b class="fc">&nbsp;            context.append(String.format(&quot;\nüí∞ REVENUS:\n‚Ä¢ Revenus total: %.2f ‚Ç¨\n‚Ä¢ Revenus ann√©e en cours: %.2f ‚Ç¨\n‚Ä¢ Revenus mois en cours: %.2f ‚Ç¨\n&quot;,</b>
<b class="pc">&nbsp;                revenusTotal != null ? revenusTotal : 0.0,</b>
<b class="pc">&nbsp;                revenusAnnee != null ? revenusAnnee : 0.0,</b>
<b class="pc">&nbsp;                revenusMois != null ? revenusMois : 0.0));</b>
&nbsp;                
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            context.append(&quot;‚Ä¢ Actes/Revenus: Erreur de r√©cup√©ration\n&quot;);</b>
&nbsp;        }
&nbsp;        
<b class="fc">&nbsp;        return context.toString();</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-12-24 03:37</div>
</div>
</body>
</html>
